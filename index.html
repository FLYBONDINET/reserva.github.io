<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Puzzle Piece Tracker</title>
<style>
  body{margin:0;background:#0f172a;color:#e5e7eb;font-family:Inter,system-ui,sans-serif}
  header{padding:16px 20px;border-bottom:1px solid #00000055;background:#0b122a}
  h1{margin:0;font-size:18px}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:14px;height:calc(100vh - 62px)}
  aside{background:#111827;padding:14px;overflow:auto}
  input,button{margin:4px 0;padding:8px;border-radius:6px;border:1px solid #444;background:#1f2937;color:#e5e7eb}
  button{cursor:pointer}
  button.primary{background:#22c55e;color:#06260f;font-weight:700}
  .canvas-wrap{overflow:auto;background:#0b1022}
  canvas{display:block;margin:auto}
</style>
</head>
<body>
<header>
  <h1>ðŸ§© Puzzle Piece Tracker</h1>
</header>
<div class="wrap">
  <aside>
    <label>Imagen</label>
    <input id="imgFile" type="file" accept="image/*" />
    <input id="imgUrl" type="text" placeholder="URL de la imagen" />
    <button id="btnLoad">Cargar</button>

    <label>Columnas Ã— Filas</label>
    <input id="cols" type="number" value="50" min="1" />
    <input id="rows" type="number" value="30" min="1" />
    <button id="btnGrid" class="primary">Aplicar</button>

    <button id="btnToggleIndex">Mostrar IDs</button>
    <button id="btnSave">Guardar progreso</button>
    <button id="btnLoadSave">Cargar progreso</button>
    <button id="btnExport">Exportar JSON</button>
    <button id="btnImport">Importar JSON</button>
    <button id="btnDownload">Descargar PNG</button>
  </aside>
  <div class="canvas-wrap">
    <canvas id="canvas"></canvas>
  </div>
</div>
<script>
(() => {
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let img = new Image();
  let cols=50, rows=30;
  let grid=[]; let showIndex=false;

  function newGrid(){grid=new Array(cols*rows).fill(0);draw();}

  function draw(){
    if(!img.src) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0);
    const cellW=canvas.width/cols, cellH=canvas.height/rows;
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const idx=r*cols+c;
        if(grid[idx]===1){
          ctx.fillStyle="#22c55e55";
          ctx.fillRect(c*cellW,r*cellH,cellW,cellH);
        } else if(grid[idx]===2){
          ctx.strokeStyle="#ef4444";
          ctx.beginPath();
          ctx.moveTo(c*cellW,r*cellH);
          ctx.lineTo((c+1)*cellW,(r+1)*cellH);
          ctx.moveTo((c+1)*cellW,r*cellH);
          ctx.lineTo(c*cellW,(r+1)*cellH);
          ctx.stroke();
        }
      }
    }
    ctx.strokeStyle="#ffffff55";ctx.lineWidth=1;
    for(let c=1;c<cols;c++){ctx.beginPath();ctx.moveTo(c*cellW,0);ctx.lineTo(c*cellW,canvas.height);ctx.stroke();}
    for(let r=1;r<rows;r++){ctx.beginPath();ctx.moveTo(0,r*cellH);ctx.lineTo(canvas.width,r*cellH);ctx.stroke();}
    if(showIndex){
      ctx.fillStyle="#fff";ctx.font="10px sans-serif";ctx.textAlign="center";ctx.textBaseline="middle";
      for(let r=0;r<rows;r++)for(let c=0;c<cols;c++)ctx.fillText(`${c+1},${r+1}`,c*cellW+cellW/2,r*cellH+cellH/2);
    }
  }

  function posToIndex(evt){
    const rect=canvas.getBoundingClientRect();
    const scaleX=canvas.width/rect.width, scaleY=canvas.height/rect.height;
    const x=(evt.clientX-rect.left)*scaleX;
    const y=(evt.clientY-rect.top)*scaleY;
    const c=Math.floor(x/(canvas.width/cols));
    const r=Math.floor(y/(canvas.height/rows));
    return r*cols+c;
  }

  canvas.addEventListener('click',e=>{
    const idx=posToIndex(e);
    if(e.shiftKey){grid[idx]=2;} else {grid[idx]=(grid[idx]+1)%3;}
    draw();
  });
  canvas.addEventListener('contextmenu',e=>{
    e.preventDefault();
    const idx=posToIndex(e);
    grid[idx]=(grid[idx]+1)%3;
    draw();
  });

  document.getElementById('btnLoad').addEventListener('click',()=>{
    const file=document.getElementById('imgFile').files[0];
    const url=document.getElementById('imgUrl').value.trim();
    if(file){img.src=URL.createObjectURL(file);} 
    else if(url){img.crossOrigin='anonymous';img.src=url;} 
    else alert('SubÃ­ un archivo o pegÃ¡ URL');
  });

  img.onload=()=>{
    canvas.width=img.naturalWidth;
    canvas.height=img.naturalHeight;
    newGrid();
  };

  document.getElementById('btnGrid').addEventListener('click',()=>{
    cols=parseInt(document.getElementById('cols').value);
    rows=parseInt(document.getElementById('rows').value);
    newGrid();
  });

  document.getElementById('btnToggleIndex').addEventListener('click',()=>{
    showIndex=!showIndex;draw();
  });

  document.getElementById('btnSave').addEventListener('click',()=>{
    localStorage.setItem('puzzleGrid',JSON.stringify({cols,rows,grid}));
    alert('Progreso guardado en el navegador');
  });
  document.getElementById('btnLoadSave').addEventListener('click',()=>{
    const saved=JSON.parse(localStorage.getItem('puzzleGrid')||'null');
    if(saved){cols=saved.cols;rows=saved.rows;grid=saved.grid;document.getElementById('cols').value=cols;document.getElementById('rows').value=rows;draw();}
    else alert('No hay progreso guardado');
  });

  document.getElementById('btnExport').addEventListener('click',()=>{
    const data=JSON.stringify({cols,rows,grid});
    const blob=new Blob([data],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='puzzle.json';
    a.click();
  });
  document.getElementById('btnImport').addEventListener('click',()=>{
    const inp=document.createElement('input');
    inp.type='file';inp.accept='application/json';
    inp.onchange=e=>{
      const file=e.target.files[0];
      const reader=new FileReader();
      reader.onload=()=>{const saved=JSON.parse(reader.result);cols=saved.cols;rows=saved.rows;grid=saved.grid;document.getElementById('cols').value=cols;document.getElementById('rows').value=rows;draw();};
      reader.readAsText(file);
    };
    inp.click();
  });

  document.getElementById('btnDownload').addEventListener('click',()=>{
    const a=document.createElement('a');
    a.download='puzzle.png';
    a.href=canvas.toDataURL('image/png');
    a.click();
  });
})();
</script>
</body>
</html>
