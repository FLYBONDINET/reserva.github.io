<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reservas de Casas</title>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; background: #f7f7f7; }
  h1 { text-align: center; }
  select { width: 100%; padding: 10px; margin-bottom: 20px; font-size: 16px; }
  #calendar { max-width: 900px; margin: auto; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<h1>Reservas de Casas</h1>

<label for="casa">Selecciona una Casa:</label>
<select id="casa">
  <option value="">-- Elige una casa --</option>
</select>

<div id="calendar"></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby6JTBwnSekeVvQEHtZlwasW09EIdhy76_ci8_3uVtDW9y7OEm6MzetmUdyX5NK4Azd/exec";

let allReservas = [];
let calendar;

document.addEventListener('DOMContentLoaded', async function() {
  const response = await fetch(SCRIPT_URL);
  allReservas = await response.json();

  // Llenar select de casas
  const casas = [...new Set(allReservas.map(r => r.propiedad))];
  const select = document.getElementById('casa');
  casas.forEach(casa => {
    const option = document.createElement('option');
    option.value = casa;
    option.textContent = casa;
    select.appendChild(option);
  });

  // Inicializar calendario
  const calendarEl = document.getElementById('calendar');
  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    selectable: false,
    events: []
  });
  calendar.render();

  select.addEventListener('change', function() {
    const casaSeleccionada = this.value;
    const eventos = allReservas
      .filter(r => r.propiedad === casaSeleccionada)
      .map(r => ({
        start: r.start,
        end: r.end ? r.end : r.start,
        title: r.title,
        display: 'background',
        backgroundColor: getColor(r.title)
      }));
    calendar.removeAllEvents();
    calendar.addEventSource(eventos);
  });
});

function getColor(estado) {
  switch(estado.toLowerCase()) {
    case 'reserva': return '#FF6B6B';
    case 'limpieza': return '#FFD93D';
    case 'mantenimiento': return '#6BCB77';
    default: return '#4D96FF';
  }
}
</script>

</body>
</html>
  let eventos = [];
  let rangoSeleccionado = null;

  function cargarPropiedades(data){
    const props = [...new Set(data.map(r=>r.propiedad).filter(p=>p))].sort();
    propiedadSelect.innerHTML = '<option value="">-- Seleccionar propiedad --</option>';
    props.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p; opt.textContent = p;
      propiedadSelect.appendChild(opt);
    });
  }

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'es',
    selectable: true,
    selectOverlap: false,
    height: "auto",
    events: function(fetchInfo, successCallback){
      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          eventos = data;
          cargarPropiedades(eventos);
          const prop = propiedadSelect.value;
          const filtrados = prop ? eventos.filter(e=>e.propiedad===prop) : eventos;
          filtrados.forEach(ev=>{
            switch((ev.estado||"").toLowerCase()){
              case "ocupado": ev.color="#f28b82"; break;
              case "limpieza": ev.color="#fdd663"; break;
              case "mantenimiento": ev.color="#aecbfa"; break;
              default: ev.color="#d7ccc8";
            }
          });
          successCallback(filtrados);
        })
        .catch(err=>alert("❌ Error al cargar reservas: "+err.message));
    },
    select: function(info){
      const prop = propiedadSelect.value;
      if(!prop){ alert("Selecciona una propiedad."); calendar.unselect(); return; }

      for(let ev of eventos){
        if(ev.propiedad!==prop) continue;
        const evStart = new Date(ev.inicio);
        const evEnd = new Date(ev.fin);
        const selStart = new Date(info.startStr);
        const selEnd = new Date(info.endStr);
        selEnd.setDate(selEnd.getDate()-1);
        if(selStart <= evEnd && selEnd >= evStart){
          alert("El rango incluye fechas ocupadas, limpieza o mantenimiento.");
          calendar.unselect();
          return;
        }
      }
      rangoSeleccionado = { start: info.startStr, end: info.endStr };
    },
    eventDidMount: function(info){
      info.el.addEventListener('mouseenter', e=>{
        tooltip.style.display="block";
        tooltip.innerHTML=`<strong>${info.event.title}</strong><br>${info.event.extendedProps.estado||''}`;
      });
      info.el.addEventListener('mousemove', e=>{
        tooltip.style.top=(e.pageY+10)+"px";
        tooltip.style.left=(e.pageX+10)+"px";
      });
      info.el.addEventListener('mouseleave', ()=>{ tooltip.style.display="none"; });
    }
  });

  calendar.render();

  propiedadSelect.addEventListener("change", ()=>{ calendar.refetchEvents(); rangoSeleccionado=null; });

  document.getElementById("reservarBtn").addEventListener("click", ()=>{
    if(!propiedadSelect.value){ alert("Selecciona una propiedad."); return; }
    if(!rangoSeleccionado){ alert("Selecciona un rango de fechas."); return; }

    const reserva = { propiedad: propiedadSelect.value, inicio:rangoSeleccionado.start, fin:rangoSeleccionado.end, estado:"Ocupado"};

    fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(reserva)
    })
    .then(res=>res.json())
    .then(resp=>{
      if(resp.result==="ok"){
        alert(`✅ Reserva registrada: ${reserva.inicio} → ${reserva.fin}`);
        rangoSeleccionado=null;
        calendar.refetchEvents();
      }else{
        alert(`❌ Error al guardar: ${resp.message||'desconocido'}`);
      }
    })
    .catch(err=>alert(`❌ Error de conexión: ${err.message}`));
  });

});
</script>

</body>
</html>
